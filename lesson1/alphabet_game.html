<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Russian Alphabet Game</title>
    <link rel="icon" type="image/png" href="../assets/favicon.png">
    <link rel="stylesheet" href="../assets/css/site.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <style>
        .game-container {
            max-width: 900px;
            margin: 2rem auto;
            text-align: center;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        /* Prevent clicks when grid is disabled */
        
        .grid.disabled {
            pointer-events: none;
            opacity: 0.5;
            /*make it look inactive */
        }
        
        .card {
            border: 1px solid #ccc;
            padding: 20px;
            font-size: 24px;
            cursor: pointer;
            user-select: none;
            background: #f9f9f9;
            font-family: var(--letter-font, 'Arial', sans-serif);
            border-radius: .5rem;
            transition: transform .08s ease, background-color .15s ease, box-shadow .15s ease;
        }
        
        .card:hover {
            background: #eef;
        }
        
        .card.correct {
            box-shadow: 0 0 0 3px #28a745 inset;
            background: #e8f8ee;
        }
        
        .card.wrong {
            box-shadow: 0 0 0 3px #dc3545 inset;
            background: #fdeaea;
        }
        
        .shake {
            animation: shake .2s linear 1;
        }
        
        @keyframes shake {
            0% {
                transform: translateX(0)
            }
            25% {
                transform: translateX(-3px)
            }
            50% {
                transform: translateX(3px)
            }
            75% {
                transform: translateX(-2px)
            }
            100% {
                transform: translateX(0)
            }
        }
        
        .score-board {
            margin-top: 1rem;
            font-size: 18px;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="../index.html"></a>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="../index.html">Home</a></li>
                    <li class="nav-item"><a class="nav-link active" href="../lessons.html">Lessons</a></li>
                    <li class="nav-item"><a class="nav-link" href="..../resources/resources.html">Resources</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="game-container">
        <h2>Russian Alphabet Game</h2>
        <p>Listen to the letter and click the correct one.</p>

        <div class="d-flex justify-content-center mb-3 gap-2">
            <button id="voiceMale" class="btn btn-outline-primary btn-sm">Male Voice</button>
            <button id="voiceFemale" class="btn btn-outline-secondary btn-sm">Female Voice</button>
            <button id="printFont" class="btn btn-outline-dark btn-sm">Print Letters</button>
            <button id="handFont" class="btn btn-outline-dark btn-sm">Handwritten Letters</button>
        </div>

        <button id="startBtn" class="btn btn-primary">Start</button>
        <button id="endBtn" class="btn btn-primary">End Game</button>
        <div class="grid mt-3" id="grid"></div>
        <div class="score-board">
            <span id="score">Score: 0</span> | <span id="streak">Streak: 0</span>
        </div>
        <div id="live" class="sr-only" aria-live="polite"></div>

        <!-- Score modal (shows final score when game ends) -->
        <div class="modal fade" id="scoreModal" tabindex="-1" aria-labelledby="scoreModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-md">
                <div class="modal-content">
                    <!-- Gradient header with icon -->
                    <div class="modal-header border-0" style="background: linear-gradient(90deg,#ff9a9e 0%, #fad0c4 55%, #fbc2eb 100%); color: #111;">
                        <div class="d-flex align-items-center gap-3">
                            <div class="fs-2">🎉</div>
                            <div>
                                <h5 class="modal-title mb-0" id="scoreModalLabel">Well done!</h5>
                                <small class="text-muted">Your game summary</small>
                            </div>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    <div class="modal-body text-center">
                        <div class="py-3">
                            <!-- Large numeric score -->
                            <div class="h1 fw-bold mb-1" id="finalScoreLarge">0</div>
                            <div class="text-muted mb-3">points</div>

                            <!-- Badges for streak / correct -->
                            <div class="mb-3">
                                <span class="badge bg-success me-2" id="finalCountBadge">Streak: 0</span>
                                <span class="badge bg-info text-dark" id="finalCorrectBadge">Correct: 0</span>
                            </div>

                            <!-- Progress bar visual -->
                            <div class="progress mb-3" style="height:10px; max-width:360px; margin:0 auto;">
                                <div class="progress-bar bg-success" id="finalProgress" role="progressbar" style="width:0%"></div>
                            </div>

                            <!-- <p class="mb-0 text-muted small">Tip: try the handwritten font for extra practice.</p> -->
                        </div>
                    </div>

                    <div class="modal-footer justify-content-center">
                        <!-- <button type="button" id="playAgainBtn" class="btn btn-primary px-4">Play again</button> -->
                        <button type="button" id="closeScoreBtn" class="btn btn-outline-secondary px-3" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <footer class="site-footer">
        &copy 2025 Sky4Tech, LLC
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // JSON map: keys are the **letter names** (match mp3 filenames)
        const LETTERS = {
            "а": {
                display: "А а"
            },
            "бэ": {
                display: "Б б"
            },
            "вэ": {
                display: "В в"
            },
            "гэ": {
                display: "Г г"
            },
            "дэ": {
                display: "Д д"
            },
            "е": {
                display: "Е е"
            },
            "ё": {
                display: "Ё ё"
            },
            "жэ": {
                display: "Ж ж"
            },
            "зэ": {
                display: "З з"
            },
            "и": {
                display: "И и"
            },
            "й": {
                display: "Й й"
            },
            "ка": {
                display: "К к"
            },
            "эл": {
                display: "Л л"
            },
            "эм": {
                display: "М м"
            },
            "эн": {
                display: "Н н"
            },
            "о": {
                display: "О о"
            },
            "пэ": {
                display: "П п"
            },
            "эр": {
                display: "Р р"
            },
            "эс": {
                display: "С с"
            },
            "тэ": {
                display: "Т т"
            },
            "у": {
                display: "У у"
            },
            "эф": {
                display: "Ф ф"
            },
            "ха": {
                display: "Х х"
            },
            "цэ": {
                display: "Ц ц"
            },
            "чэ": {
                display: "Ч ч"
            },
            "ша": {
                display: "Ш ш"
            },
            "ща": {
                display: "Щ щ"
            },
            "твёрдый_знак": {
                display: "Ъ ъ"
            },
            "ы": {
                display: "Ы ы"
            },
            "мягкий_знак": {
                display: "Ь ь"
            },
            "э": {
                display: "Э э"
            },
            "ю": {
                display: "Ю ю"
            },
            "я": {
                display: "Я я"
            }
        };

        let currentKey = null; // current **letter name**
        let wrongCount = 0; // wrong attempts this round (0 or 1)
        let score = 0;
        let count = 0; // total attempts
        let streak = 0;
        let voice = 'male';
        let letterFont = 'print';

        const grid = document.getElementById('grid');
        const scoreEl = document.getElementById('score');
        const streakEl = document.getElementById('streak');
        const live = document.getElementById('live');

        function buildGrid() {
            grid.innerHTML = '';
            Object.entries(LETTERS).forEach(([name, info]) => {
                const div = document.createElement('button');
                div.type = 'button';
                div.className = 'card';
                div.style.fontFamily = (letterFont === 'hand') ? 'Pacifico, cursive' : 'Arial, sans-serif';
                div.textContent = info.display;
                div.onclick = () => checkAnswer(name, div);
                grid.appendChild(div);
            });
        }

        function playLetterByName(letterName) {
            const safe = encodeURIComponent(letterName);
            const audio = new Audio(`../assets/sound/${voice}/${safe}.mp3`);
            audio.onerror = () => console.warn('Missing mp3 for', letterName);
            audio.play();
        }

        // --- Feedback sounds (no external assets needed) ---
        let AC = null;

        function ctx() {
            if (!AC) AC = new(window.AudioContext || window.webkitAudioContext)();
            return AC;
        }

        function pleasantChime() {
            // two short sine tones: C5 -> E5
            const a = ctx();
            const now = a.currentTime;
            const seq = [523.25, 659.25];
            seq.forEach((f, i) => {
                const o = a.createOscillator(),
                    g = a.createGain();
                o.type = 'sine';
                o.frequency.value = f;
                g.gain.setValueAtTime(0.0001, now + i * 0.12);
                g.gain.exponentialRampToValueAtTime(0.2, now + i * 0.12 + 0.02);
                g.gain.exponentialRampToValueAtTime(0.0001, now + i * 0.12 + 0.25);
                o.connect(g).connect(a.destination);
                o.start(now + i * 0.12);
                o.stop(now + i * 0.12 + 0.26);
            });
        }

        function buzz() {
            const a = ctx();
            const t0 = a.currentTime;
            const o = a.createOscillator();
            const g = a.createGain();
            o.type = 'square';
            o.frequency.setValueAtTime(120, t0);
            g.gain.setValueAtTime(0.0001, t0);
            g.gain.exponentialRampToValueAtTime(0.25, t0 + 0.02);
            g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.25);
            o.connect(g).connect(a.destination);
            o.start(t0);
            o.stop(t0 + 0.28);
        }

        function announce(msg) {
            live.textContent = msg;
        }

        function nextQuestion() {
            wrongCount = 0;
            const keys = Object.keys(LETTERS);
            const randomIndex = Math.floor(Math.random() * keys.length);
            currentKey = keys[randomIndex];
            playLetterByName(currentKey);
            count += 1;
        }

        function updateHUD() {
            scoreEl.textContent = 'Score: ' + score + '/' + count;
            streakEl.textContent = 'Streak: ' + streak;
        }

        function checkAnswer(chosenKey, el) {

            const PAUSE = 100; // ms before next question on correct
            if (!currentKey) return; // no question yet
            if (chosenKey === currentKey) {
                score++;
                streak++;
                el.classList.add('correct');
                pleasantChime();
                announce('Correct');
                setTimeout(() => {
                    el.classList.remove('correct');
                    updateHUD();
                    nextQuestion();
                }, PAUSE);
            } else {
                streak = 0;
                updateHUD();
                el.classList.add('wrong');
                grid.classList.add('shake');
                setTimeout(() => {
                    el.classList.remove('wrong');
                    grid.classList.remove('shake');
                }, PAUSE * 2);

                if (wrongCount === 0) {
                    wrongCount = 1;
                    announce('Try again');
                    // repeat the same target
                    playLetterByName(currentKey);
                } else {
                    announce('Incorrect');
                    buzz();
                    setTimeout(() => {
                        nextQuestion();
                    }, PAUSE * 5);
                }
            }
        }

        document.getElementById('startBtn').onclick = (el) => {

            // document.getElementById('startBtn').style.display = 'none';
            // el.target.disabled = true;
            document.getElementById('startBtn').style.display = "none";
            document.getElementById('endBtn').style.display = "inline-block";
            // On start, play the first letter
            if (currentKey) {
                playLetterByName(currentKey);
            } else {
                nextQuestion();
            }
            grid.classList.remove("disabled");
        };

        document.getElementById('endBtn').onclick = (el) => {
            // Capture final values to show to the user
            const finalScore = score;
            const countFinal = count;

            currentKey = null; // current **letter name**
            wrongCount = 0; // wrong attempts this round (0 or 1)
            score = 0;
            count = 0; // total attempts
            streak = 0;
            voice = 'male';
            letterFont = 'print';
            buildGrid();
            updateHUD();
            grid.classList.add("disabled");
            document.getElementById('endBtn').style.display = "none";
            document.getElementById('startBtn').style.display = "inline-block";
            announce('Game ended. Click Start to play again.'); // accessibility

            // Populate modal content and show it
            document.getElementById('finalScoreLarge').textContent = finalScore;
            document.getElementById('finalCountBadge').textContent = `Letters Played: ${countFinal}`;

            // Count correct answers = finalScore (since each correct increments score)
            document.getElementById('finalCorrectBadge').textContent = `Correct: ${finalScore}`;

            // Update progress bar: show percentage of letters correct (clamped)

            let pct = 0;
            if (countFinal > 0)
                pct = Math.round(Math.min(100, (finalScore / countFinal) * 100));
            const progressEl = document.getElementById('finalProgress');
            progressEl.style.width = pct + '%';
            progressEl.setAttribute('aria-valuenow', pct);

            // Show modal
            const scoreModalEl = document.getElementById('scoreModal');
            const scoreModal = new bootstrap.Modal(scoreModalEl);
            scoreModal.show();
        };

        document.getElementById('voiceMale').onclick = () => {
            voice = 'male';
        };
        document.getElementById('voiceFemale').onclick = () => {
            voice = 'female';
        };
        document.getElementById('printFont').onclick = () => {
            letterFont = 'print';
            buildGrid();
        };
        document.getElementById('handFont').onclick = () => {
            letterFont = 'hand';
            buildGrid();
        };

        buildGrid();
        grid.classList.add("disabled");
        document.getElementById('endBtn').style.display = "none";
        document.getElementById('startBtn').style.display = "inline-block";
    </script>
</body>

</html>